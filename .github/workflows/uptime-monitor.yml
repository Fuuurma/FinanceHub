name: Uptime Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.financehub.com/health/ || echo "000")
          echo "API response: $response"
          if [ "$response" != "200" ]; then
            echo "API health check FAILED with status: $response"
            exit 1
          fi
          echo "API health check PASSED"

      - name: Check frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://financehub.com/ || echo "000")
          echo "Frontend response: $response"
          if [ "$response" != "200" ]; then
            echo "Frontend health check FAILED with status: $response"
            exit 1
          fi
          echo "Frontend health check PASSED"

      - name: Check API status endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.financehub.com/api/v1/status/ || echo "000")
          echo "Status endpoint response: $response"
          if [ "$response" != "200" ]; then
            echo "Status endpoint FAILED with status: $response"
            exit 1
          fi
          echo "Status endpoint PASSED"

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: 'error'
          text: |
            ðŸš¨ Uptime Monitor Alert
            
            API or frontend is down!
            
            Run: ${{ github.run_id }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Success notification
        if: success()
        run: echo "âœ… All health checks passed"
